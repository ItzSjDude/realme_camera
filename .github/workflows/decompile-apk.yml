name: APK Decompile and Rename

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'APK Download URL (optional, will use uploaded APK if empty)'
        required: false
        type: string
      branch_name:
        description: 'Target branch name'
        required: false
        default: 'deobfuscated'
        type: string
        
permissions:
  contents: write        

jobs:
  decompile-and-rename:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true 
          
      - name: ðŸ“¦ Fetch LFS Files
        run: |
          git lfs pull
          echo "âœ… Pulled real APK files from Git LFS"    
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ðŸ“¦ Download JADX
        run: |
          echo "ðŸ“¦ Downloading JADX..."
          wget -q https://github.com/skylot/jadx/releases/download/v1.5.3/jadx-1.5.3.zip
          unzip -q jadx-1.5.3.zip -d jadx
          chmod +x jadx/bin/jadx
          echo "âœ… JADX installed successfully"
      
      - name: ðŸ“± Get APK File
        run: |
          if [ -n "${{ inputs.apk_url }}" ]; then
            echo "ðŸ“¥ Downloading APK from URL..."
            wget -q "${{ inputs.apk_url }}" -O app.apk
          else
            echo "ðŸ” Looking for APK in repository..."
            APK_FILE=$(find . -name "*.apk" -type f | head -n 1)
            if [ -z "$APK_FILE" ]; then
              echo "âŒ No APK file found!"
              echo "Please either:"
              echo "  1. Provide apk_url in workflow dispatch"
              echo "  2. Commit an APK file to the repository"
              exit 1
            fi
            echo "âœ… Found APK: $APK_FILE"
            cp "$APK_FILE" app.apk
          fi
      
      - name: ðŸ”“ Decompile APK with JADX
        run: |
          echo "ðŸ”“ Decompiling APK..."
          mkdir -p decompiled
          set +e  # â¬…ï¸ prevent the job from failing due to JADX exit code 1
          ./jadx/bin/jadx -d decompiled app.apk --no-res --no-imports
          EXIT_CODE=$?
          set -e
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ JADX finished with warnings (exit code $EXIT_CODE)."
            echo "Continuing since decompilation output was generated successfully."
          else
            echo "âœ… Decompilation complete"
          fi
          echo "ðŸ“ Decompiled structure:"
          find decompiled -name "*.java" | head -20
      
      - name: ðŸ“¦ Install Python deps
        if: always()
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: ðŸ”„ Run Renamer Script from repo
        run: |
          echo "ðŸ”„ Running renamer script from scripts/renamer.py..."
          python scripts/extract_source.py decompiled/sources
      
      - name: ðŸ“Š Generate Summary
        run: |
          echo "ðŸ“Š Generating summary..."
          
          TOTAL_FILES=$(find decompiled/sources -name "*.java" | wc -l)
          TOTAL_SIZE=$(du -sh decompiled/sources | cut -f1)
          
          cat > DECOMPILE_SUMMARY.md << EOF
          # ðŸ“± APK Decompilation & Deobfuscation Report
          
          **Generated:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ## ðŸ“Š Statistics
          - **Total Java Files:** $TOTAL_FILES
          - **Total Size:** $TOTAL_SIZE
          - **Branch:** ${{ inputs.branch_name }}
          
          ## ðŸ”§ Tools Used
          - **JADX:** Latest version
          - **Python Renamer:** Custom deobfuscation script
          
          ## ðŸ“ Structure
          \`\`\`
          $(tree -L 2 -d decompiled/sources | head -20)
          \`\`\`
          
          ## âœ… Process Completed Successfully
          All obfuscated class names have been renamed to their original names based on the "compiled from" comments.
          EOF
          
          echo "âœ… Summary generated"
          cat DECOMPILE_SUMMARY.md
      
      - name: ðŸŒ¿ Create and Switch to Branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          BRANCH="${{ inputs.branch_name }}"
          
          # Check if branch exists
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "ðŸŒ¿ Branch $BRANCH exists, checking out..."
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git pull origin "$BRANCH"
          else
            echo "ðŸ†• Creating new branch $BRANCH..."
            git checkout -b "$BRANCH"
          fi
      
      - name: ðŸ“¤ Commit and Push Changes
        run: |
          git add decompiled/ DECOMPILE_SUMMARY.md
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "âš ï¸  No changes to commit"
          else
            git commit -m "ðŸ”“ Decompiled and deobfuscated APK

          - Decompiled APK using JADX
          - Renamed obfuscated classes to original names
          - Updated all cross-file references
          - Generated decompilation summary
          
          Generated by GitHub Actions
          Workflow run: ${{ github.run_id }}"
            
            git push origin "${{ inputs.branch_name }}"
            echo "âœ… Changes pushed to branch: ${{ inputs.branch_name }}"
          fi
      
      - name: ðŸŽ‰ Success Summary
        if: success()
        run: |
          echo "ðŸŽ‰ ============================================"
          echo "   APK DECOMPILATION COMPLETED SUCCESSFULLY"
          echo "============================================"
          echo ""
          echo "âœ… Decompiled APK with JADX"
          echo "âœ… Renamed all obfuscated classes"
          echo "âœ… Updated cross-file references"
          echo "âœ… Committed to branch: ${{ inputs.branch_name }}"
          echo ""
          echo "ðŸ“ View the decompiled code:"
          echo "   https://github.com/${{ github.repository }}/tree/${{ inputs.branch_name }}"
          echo ""
          echo "ðŸŽ‰ ============================================"
