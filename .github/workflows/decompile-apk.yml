name: APK Decompile and Rename

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'APK Download URL (optional, will use uploaded APK if empty)'
        required: false
        type: string
      branch_name:
        description: 'Target branch name'
        required: false
        default: 'deobfuscated'
        type: string
        
permissions:
  contents: write        

jobs:
  decompile-and-rename:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true 
          
      - name: ðŸ“¦ Fetch LFS Files
        run: |
          git lfs pull
          echo "âœ… Pulled real APK files from Git LFS"    
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ðŸ“¦ Download JADX
        run: |
          echo "ðŸ“¦ Downloading JADX..."
          wget -q https://github.com/skylot/jadx/releases/download/v1.5.3/jadx-1.5.3.zip
          unzip -q jadx-1.5.3.zip -d jadx
          chmod +x jadx/bin/jadx
          echo "âœ… JADX installed successfully"
      
      - name: ðŸ“± Get APK File
        run: |
          if [ -n "${{ inputs.apk_url }}" ]; then
            echo "ðŸ“¥ Downloading APK from URL..."
            wget -q "${{ inputs.apk_url }}" -O app.apk
          else
            echo "ðŸ” Looking for APK in repository..."
            APK_FILE=$(find . -name "*.apk" -type f | head -n 1)
            if [ -z "$APK_FILE" ]; then
              echo "âŒ No APK file found!"
              echo "Please either:"
              echo "  1. Provide apk_url in workflow dispatch"
              echo "  2. Commit an APK file to the repository"
              exit 1
            fi
            echo "âœ… Found APK: $APK_FILE"
            cp "$APK_FILE" app.apk
          fi
      
      - name: ðŸ”“ Decompile APK with JADX
        run: |
          echo "ðŸ”“ Decompiling APK..."
          mkdir -p decompiled
          set +e  # â¬…ï¸ prevent the job from failing due to JADX exit code 1
          ./jadx/bin/jadx -d decompiled app.apk --no-res --no-imports
          EXIT_CODE=$?
          set -e
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ JADX finished with warnings (exit code $EXIT_CODE)."
            echo "Continuing since decompilation output was generated successfully."
          else
            echo "âœ… Decompilation complete"
          fi
          echo "ðŸ“ Decompiled structure:"
          find decompiled -name "*.java" | head -20
      
      - name: ðŸ“ Create Renamer Script
        run: |
          cat > renamer.py << 'EOFSCRIPT'
          import re
          from pathlib import Path
          from collections import defaultdict

          class SimpleJavaRenamer:
              def __init__(self, base_dir):
                  self.base_dir = Path(base_dir)
                  self.rename_map = {}   # current class -> new class
                  self.name_count = defaultdict(int)

  
              def get_original_name(self, content):
                  """Extract original class name from 'compiled from' comment"""
                  match = re.search(r'/\*\s*compiled from:\s*([^\s*]+)\s*\*/', content, re.IGNORECASE)
                  if match:
                      name = match.group(1).replace('.java', '')
                      return name
                  return None

              def get_class_name(self, content):
                  """Get current class/interface/enum name"""
                  match = re.search(r'(?:public\s+)?(?:class|interface|enum)\s+(\w+)', content)
                  if match:
                      return match.group(1)
                  return None

              def build_rename_map(self):
                  java_files = list(self.base_dir.rglob("*.java"))

                  for file_path in java_files:
                       try:
                          content = file_path.read_text(encoding="utf-8")
                          current_class = self.get_class_name(content)
                          original_name = self.get_original_name(content)
                
                          if current_class and original_name and current_class != original_name:
                              count = self.name_count[original_name]
                              new_name = original_name if count == 0 else f"{original_name}_{count}"
                              self.rename_map[current_class] = new_name
                              self.name_count[original_name] += 1
                      except Exception as e:
                          print(f"âš ï¸  Error reading {file_path}: {e}")

                  print(f"âœ… Rename map built ({len(self.rename_map)} entries)")

              def rename_files(self):
                  java_files = list(self.base_dir.rglob("*.java"))
                  for file_path in java_files:
                      try:
                          content = file_path.read_text(encoding="utf-8")
                          current_class = self.get_class_name(content)
                          if current_class in self.rename_map:
                              new_name = self.rename_map[current_class]
                              new_file_path = file_path.parent / f"{new_name}.java"
                              if new_file_path.exists():
                                  # backup old file
                                  new_file_path = file_path.parent / f"{new_name}_DUP_{file_path.stem}.java"
                              file_path.rename(new_file_path)
                      except Exception as e:
                          print(f"âš ï¸ Error renaming {file_path}: {e}")
                  print("âœ… Files renamed successfully")

              def replace_references(self):
                  java_files = list(self.base_dir.rglob("*.java"))
                  for file_path in java_files:
                      try:
                          content = file_path.read_text(encoding="utf-8")
                          modified = False
                          for old, new in self.rename_map.items():
                              pattern = rf'\b{old}\b'
                              if re.search(pattern, content):
                                  content = re.sub(pattern, new, content)
                                  modified = True
                          if modified:
                              file_path.write_text(content, encoding="utf-8")
                      except Exception as e:
                          print(f"âš ï¸ Error updating references in {file_path}: {e}")
                  print("âœ… References updated successfully")

              def process(self): 
                  print("ðŸš€ Starting Java renaming process...")
                  self.build_rename_map()
                  self.rename_files()
                  self.replace_references()
                  print("ðŸŽ‰ All done!")

          if __name__ == "__main__":
              import sys
              target_dir = sys.argv[1] if len(sys.argv) > 1 else "decompiled/sources"
              renamer = SimpleJavaRenamer(target_dir)
              renamer.process()

          EOFSCRIPT
          
          echo "âœ… Renamer script created"
      
      - name: ðŸ”„ Run Renamer Script
        run: |
          echo "ðŸ”„ Running renamer script..."
          python renamer.py decompiled/sources
      
      - name: ðŸ“Š Generate Summary
        run: |
          echo "ðŸ“Š Generating summary..."
          
          TOTAL_FILES=$(find decompiled/sources -name "*.java" | wc -l)
          TOTAL_SIZE=$(du -sh decompiled/sources | cut -f1)
          
          cat > DECOMPILE_SUMMARY.md << EOF
          # ðŸ“± APK Decompilation & Deobfuscation Report
          
          **Generated:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ## ðŸ“Š Statistics
          - **Total Java Files:** $TOTAL_FILES
          - **Total Size:** $TOTAL_SIZE
          - **Branch:** ${{ inputs.branch_name }}
          
          ## ðŸ”§ Tools Used
          - **JADX:** Latest version
          - **Python Renamer:** Custom deobfuscation script
          
          ## ðŸ“ Structure
          \`\`\`
          $(tree -L 2 -d decompiled/sources | head -20)
          \`\`\`
          
          ## âœ… Process Completed Successfully
          All obfuscated class names have been renamed to their original names based on the "compiled from" comments.
          EOF
          
          echo "âœ… Summary generated"
          cat DECOMPILE_SUMMARY.md
      
      - name: ðŸŒ¿ Create and Switch to Branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          BRANCH="${{ inputs.branch_name }}"
          
          # Check if branch exists
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "ðŸŒ¿ Branch $BRANCH exists, checking out..."
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git pull origin "$BRANCH"
          else
            echo "ðŸ†• Creating new branch $BRANCH..."
            git checkout -b "$BRANCH"
          fi
      
      - name: ðŸ“¤ Commit and Push Changes
        run: |
          git add decompiled/ DECOMPILE_SUMMARY.md
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "âš ï¸  No changes to commit"
          else
            git commit -m "ðŸ”“ Decompiled and deobfuscated APK

          - Decompiled APK using JADX
          - Renamed obfuscated classes to original names
          - Updated all cross-file references
          - Generated decompilation summary
          
          Generated by GitHub Actions
          Workflow run: ${{ github.run_id }}"
            
            git push origin "${{ inputs.branch_name }}"
            echo "âœ… Changes pushed to branch: ${{ inputs.branch_name }}"
          fi
      
      - name: ðŸŽ‰ Success Summary
        if: success()
        run: |
          echo "ðŸŽ‰ ============================================"
          echo "   APK DECOMPILATION COMPLETED SUCCESSFULLY"
          echo "============================================"
          echo ""
          echo "âœ… Decompiled APK with JADX"
          echo "âœ… Renamed all obfuscated classes"
          echo "âœ… Updated cross-file references"
          echo "âœ… Committed to branch: ${{ inputs.branch_name }}"
          echo ""
          echo "ðŸ“ View the decompiled code:"
          echo "   https://github.com/${{ github.repository }}/tree/${{ inputs.branch_name }}"
          echo ""
          echo "ðŸŽ‰ ============================================"
